<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login | Moniebase</title>
    <link rel="stylesheet" href="login.css" />
    <!-- Preconnect to Firebase domains to improve load time -->
    <link rel="preconnect" href="https://www.gstatic.com" />
    <link rel="preconnect" href="https://paytrust-71e30.firebaseapp.com" />
    <!-- Defer non-critical JavaScript -->
    <script
      defer
      src="https://www.gstatic.com/firebasejs/9.14.0/firebase-app-compat.js"
    ></script>
    <script
      defer
      src="https://www.gstatic.com/firebasejs/9.14.0/firebase-auth-compat.js"
    ></script>
    <script
      defer
      src="https://www.gstatic.com/firebasejs/9.14.0/firebase-database-compat.js"
    ></script>
    <link rel="manifest" href="/manifest.json" />
    <script
      src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js"
      defer
    ></script>
  </head>
  <body>
    <div class="login-container">
      <div class="login-card">
        <div class="login-header">
          <img
            src="https://cdn-icons-png.flaticon.com/128/17374/17374963.png"
            alt="PayTrust Logo"
            class="login-logo"
            width="80"
            height="80"
            loading="eager"
          />
          <h1>Welcome Back!</h1>
          <p class="subtitle">Login to access your account</p>
        </div>

        <form id="loginForm" class="login-form">
          <div class="form-group">
            <label for="email">Email Address</label>
            <div class="input-container">
              <svg
                class="input-icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                width="18"
                height="18"
              >
                <path
                  d="M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm17 4.238l-7.928 7.1L4 7.216V19h16V7.238zM4.511 5l7.55 6.662L19.502 5H4.511z"
                  fill="#607D8B"
                />
              </svg>
              <input
                type="email"
                id="email"
                placeholder="Enter your email address"
                autocomplete="email"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <div class="input-container">
              <svg
                class="input-icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                width="18"
                height="18"
              >
                <path
                  d="M6 8V7a6 6 0 1 1 12 0v1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h2zm13 2H5v10h14V10zm-8 5.732a2 2 0 1 1 2 0V18h-2v-2.268zM8 8h8V7a4 4 0 1 0-8 0v1z"
                  fill="#607D8B"
                />
              </svg>
              <input
                type="password"
                id="password"
                placeholder="Enter your password"
                autocomplete="current-password"
                required
              />
              <button
                type="button"
                id="togglePassword"
                class="toggle-password"
                aria-label="Toggle password visibility"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  width="18"
                  height="18"
                >
                  <path
                    d="M12 3c5.392 0 9.878 3.88 10.819 9-.94 5.12-5.427 9-10.819 9-5.392 0-9.878-3.88-10.819-9C2.121 6.88 6.608 3 12 3zm0 16a9.005 9.005 0 0 0 8.777-7 9.005 9.005 0 0 0-17.554 0A9.005 9.005 0 0 0 12 19zm0-2.5a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9zm0-2a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"
                    fill="#607D8B"
                  />
                </svg>
              </button>
            </div>
          </div>

          <div class="form-extras">
            <label class="remember-me">
              <input type="checkbox" id="rememberMe" />
              <span>Remember me</span>
            </label>
            <a href="../app/reset-password.html" class="forgot-password"
              >Forgot password?</a
            >
          </div>

          <button type="submit" class="login-button">
            <span>Login</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              width="18"
              height="18"
            >
              <path
                d="M13.172 12l-4.95-4.95 1.414-1.414L16 12l-6.364 6.364-1.414-1.414z"
                fill="currentColor"
              />
            </svg>
          </button>

          <div class="separator">
            <span>OR</span>
          </div>

          <button type="button" id="googleSignIn" class="social-button">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              width="18"
              height="18"
            >
              <path
                d="M3.064 7.51A9.996 9.996 0 0 1 12 2c2.695 0 4.959.99 6.69 2.605l-2.867 2.868C14.786 6.482 13.468 5.977 12 5.977c-2.605 0-4.81 1.76-5.595 4.123-.2.6-.314 1.24-.314 1.9 0 .66.114 1.3.314 1.9.786 2.364 2.99 4.123 5.595 4.123 1.345 0 2.49-.355 3.386-.955a4.6 4.6 0 0 0 1.996-3.018H12v-3.868h9.418c.118.654.182 1.336.182 2.045 0 3.046-1.09 5.61-2.982 7.35C16.964 21.105 14.7 22 12 22A9.996 9.996 0 0 1 2 12c0-1.614.386-3.14 1.064-4.49z"
                fill="#4285F4"
              />
            </svg>
            <span>Continue with Google</span>
          </button>
        </form>

        <p class="signup-prompt">
          Don't have an account? <a href="signup.html">Sign Up</a>
        </p>
      </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDJP2XIR51qGTLINiKvEoscYTMt11CaZ5s",
          authDomain: "paytrust-71e30.firebaseapp.com",
          databaseURL: "https://paytrust-71e30-default-rtdb.firebaseio.com/",
          projectId: "paytrust-71e30",
          storageBucket: "paytrust-71e30.appspot.com",
          messagingSenderId: "492609516838",
          appId: "1:492609516838:android:5a924ad3b7e8e508fa3de7",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Initialize OneSignal
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(function (OneSignal) {
          OneSignal.init({
            appId: "91409f09-e008-4776-a821-fc154ad3e4be",
            safari_web_id: "web.onesignal.auto.482941778795",
            notifyButton: {
              enable: true,
            },
            allowLocalhostAsSecureOrigin: true,
          });

          // Show notification prompt
          OneSignal.showSlidedownPrompt();
        });

        // Toast notification system
        function showToast(message, type = "info") {
          const toastContainer = document.getElementById("toast-container");
          const toast = document.createElement("div");
          toast.className = `toast toast-${type}`;

          toast.innerHTML = `
      <div class="toast-content">
        <span>${message}</span>
        <button class="toast-close">Ã—</button>
      </div>
    `;

          toastContainer.appendChild(toast);

          setTimeout(() => toast.classList.add("visible"), 10);

          const timeout = setTimeout(() => removeToast(toast), 4000);

          toast.querySelector(".toast-close").addEventListener("click", () => {
            clearTimeout(timeout);
            removeToast(toast);
          });
        }

        function removeToast(toast) {
          toast.classList.remove("visible");
          setTimeout(() => toast.remove(), 300);
        }

        // Password visibility toggle
        const togglePassword = document.getElementById("togglePassword");
        const passwordInput = document.getElementById("password");

        togglePassword.addEventListener("click", () => {
          const type =
            passwordInput.getAttribute("type") === "password"
              ? "text"
              : "password";
          passwordInput.setAttribute("type", type);

          togglePassword.innerHTML =
            type === "text"
              ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path d="M17.882 19.297A10.949 10.949 0 0 1 12 21c-5.392 0-9.878-3.88-10.819-9a10.982 10.982 0 0 1 3.34-6.066L1.392 2.808l1.415-1.415 19.799 19.8-1.415 1.414-3.31-3.31zM5.935 7.35A8.965 8.965 0 0 0 3.223 12a9.005 9.005 0 0 0 13.201 5.838l-2.028-2.028A4.5 4.5 0 0 1 8.19 9.604L5.935 7.35zm6.979 6.978l-3.242-3.242a2.5 2.5 0 0 0 3.241 3.241zm7.893 2.264l-1.431-1.43A8.935 8.935 0 0 0 20.777 12 9.005 9.005 0 0 0 9.552 5.338L7.974 3.76C9.221 3.27 10.58 3 12 3c5.392 0 9.878 3.88 10.819 9a10.947 10.947 0 0 1-2.012 4.592zm-9.084-9.084l1.442 1.442a2.5 2.5 0 0 0-1.442-1.442z" fill="#607D8B"/></svg>'
              : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path d="M12 3c5.392 0 9.878 3.88 10.819 9-.94 5.12-5.427 9-10.819 9-5.392 0-9.878-3.88-10.819-9C2.121 6.88 6.608 3 12 3zm0 16a9.005 9.005 0 0 0 8.777-7 9.005 9.005 0 0 0-17.554 0A9.005 9.005 0 0 0 12 19zm0-2.5a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9zm0-2a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z" fill="#607D8B"/></svg>';
        });

        // Handle successful login (used by both email and Google auth)
        async function handleLoginSuccess(user) {
          // Save user info
          localStorage.setItem(
            "user",
            JSON.stringify({
              uid: user.uid,
              email: user.email,
              displayName: user.displayName || null,
              photoURL: user.photoURL || null,
            })
          );

          // OneSignal user tracking
          if (window.OneSignal) {
            try {
              await window.OneSignal.setExternalUserId(user.uid);
              if (user.email) {
                await window.OneSignal.setEmail(user.email);
              }
            } catch (error) {
              console.error("OneSignal error:", error);
            }
          }

          showToast("Login successful! Redirecting...", "success");
          setTimeout(() => (window.location.href = "home.html"), 1500);
        }

        // Email login
        document
          .getElementById("loginForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const rememberMe = document.getElementById("rememberMe").checked;

            const loginButton = document.querySelector(".login-button");
            const originalButtonText = loginButton.innerHTML;

            loginButton.disabled = true;
            loginButton.innerHTML =
              '<span>Logging in...</span><div class="spinner"></div>';

            try {
              const persistence = rememberMe
                ? firebase.auth.Auth.Persistence.LOCAL
                : firebase.auth.Auth.Persistence.SESSION;

              await auth.setPersistence(persistence);
              const userCredential = await auth.signInWithEmailAndPassword(
                email,
                password
              );
              await handleLoginSuccess(userCredential.user);
            } catch (error) {
              console.error("Login error:", error);

              let errorMessage;
              switch (error.code) {
                case "auth/user-not-found":
                case "auth/wrong-password":
                  errorMessage =
                    "Incorrect email or password. Please try again.";
                  break;
                case "auth/too-many-requests":
                  errorMessage =
                    "Too many failed attempts. Please try again later.";
                  break;
                case "auth/network-request-failed":
                  errorMessage = "Network error. Please check your connection.";
                  break;
                default:
                  errorMessage = error.message;
              }

              showToast(errorMessage, "error");
              loginButton.disabled = false;
              loginButton.innerHTML = originalButtonText;
            }
          });

        // Google Sign-In
        document
          .getElementById("googleSignIn")
          .addEventListener("click", async () => {
            try {
              const provider = new firebase.auth.GoogleAuthProvider();
              provider.setCustomParameters({ prompt: "select_account" });

              const result = await auth.signInWithPopup(provider);
              await handleLoginSuccess(result.user);
            } catch (error) {
              console.error("Google Sign-In error:", error);
              showToast(error.message, "error");
            }
          });
      });
    </script>
  </body>
</html>
