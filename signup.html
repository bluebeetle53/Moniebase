<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up | Moniebase</title>
    <link rel="stylesheet" href="signup.css" />
    <!-- Preconnect to Firebase domains to improve load time -->
    <link rel="preconnect" href="https://www.gstatic.com" />
    <link rel="preconnect" href="https://paytrust-71e30.firebaseapp.com" />
    <!-- Defer non-critical JavaScript -->
    <script
      defer
      src="https://www.gstatic.com/firebasejs/9.14.0/firebase-app-compat.js"
    ></script>
    <script
      defer
      src="https://www.gstatic.com/firebasejs/9.14.0/firebase-auth-compat.js"
    ></script>
    <script
      defer
      src="https://www.gstatic.com/firebasejs/9.14.0/firebase-database-compat.js"
    ></script>
  </head>
  <body>
    <div class="signup-container">
      <div class="signup-card">
        <div class="signup-header">
          <img
            src="https://cdn-icons-png.flaticon.com/128/17374/17374963.png"
            alt="PayTrust Logo"
            class="signup-logo"
            width="80"
            height="80"
            loading="eager"
          />
          <h1>Create Your Account</h1>
          <p class="subtitle">
            Join PayTrust today and take control of your finances
          </p>
        </div>

        <form id="signupForm" class="signup-form">
          <div class="form-group">
            <label for="fullName">Full Name</label>
            <div class="input-container">
              <svg
                class="input-icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                width="18"
                height="18"
              >
                <path
                  d="M12 2a5 5 0 0 1 5 5v2a5 5 0 0 1-10 0V7a5 5 0 0 1 5-5zm7 14h-1.8c-.3 0-.6.1-.8.3l-1.8 1.8c-1.5 1.5-3.9 1.5-5.4 0L7.5 16.3c-.2-.2-.5-.3-.8-.3H5c-1.1 0-2 .9-2 2v1c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-1c0-1.1-.9-2-2-2z"
                  fill="#607D8B"
                />
              </svg>
              <input
                type="text"
                id="fullName"
                placeholder="Enter your full name"
                autocomplete="name"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="email">Email Address</label>
            <div class="input-container">
              <svg
                class="input-icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                width="18"
                height="18"
              >
                <path
                  d="M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm17 4.238l-7.928 7.1L4 7.216V19h16V7.238zM4.511 5l7.55 6.662L19.502 5H4.511z"
                  fill="#607D8B"
                />
              </svg>
              <input
                type="email"
                id="email"
                placeholder="Enter your email address"
                autocomplete="email"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="password">Password</label>
              <div class="input-container">
                <svg
                  class="input-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  width="18"
                  height="18"
                >
                  <path
                    d="M6 8V7a6 6 0 1 1 12 0v1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h2zm13 2H5v10h14V10zm-8 5.732a2 2 0 1 1 2 0V18h-2v-2.268zM8 8h8V7a4 4 0 1 0-8 0v1z"
                    fill="#607D8B"
                  />
                </svg>
                <input
                  type="password"
                  id="password"
                  placeholder="Create a strong password"
                  autocomplete="new-password"
                  required
                />
                <button
                  type="button"
                  id="togglePassword"
                  class="toggle-password"
                  aria-label="Toggle password visibility"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    width="18"
                    height="18"
                  >
                    <path
                      d="M12 3c5.392 0 9.878 3.88 10.819 9-.94 5.12-5.427 9-10.819 9-5.392 0-9.878-3.88-10.819-9C2.121 6.88 6.608 3 12 3zm0 16a9.005 9.005 0 0 0 8.777-7 9.005 9.005 0 0 0-17.554 0A9.005 9.005 0 0 0 12 19zm0-2.5a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9zm0-2a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"
                      fill="#607D8B"
                    />
                  </svg>
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="phone">Phone Number</label>
              <div class="input-container">
                <svg
                  class="input-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  width="18"
                  height="18"
                >
                  <path
                    d="M21 16.42v3.536a1 1 0 0 1-.93.998c-.437.03-.794.046-1.07.046-8.837 0-16-7.163-16-16 0-.276.015-.633.046-1.07A1 1 0 0 1 4.044 3H7.58a.5.5 0 0 1 .498.45c.023.23.044.413.064.552A13.901 13.901 0 0 0 9.35 8.003c.095.2.033.439-.147.567l-2.158 1.542a13.047 13.047 0 0 0 6.844 6.844l1.54-2.154a.462.462 0 0 1 .573-.149 13.901 13.901 0 0 0 4 1.205c.139.02.322.042.55.064a.5.5 0 0 1 .449.498z"
                    fill="#607D8B"
                  />
                </svg>
                <input
                  type="tel"
                  id="phone"
                  placeholder="Enter your phone number"
                  autocomplete="tel"
                  required
                />
              </div>
            </div>
          </div>

          <div class="form-group terms-container">
            <label class="terms-checkbox">
              <input type="checkbox" id="termsAgreement" required />
              <span
                >I agree to the
                <a href="terms.html" target="_blank">Terms of Service</a> and
                <a href="privacy.html" target="_blank">Privacy Policy</a></span
              >
            </label>
          </div>

          <button type="submit" class="signup-button">
            <span>Create Account</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              width="18"
              height="18"
            >
              <path
                d="M13.172 12l-4.95-4.95 1.414-1.414L16 12l-6.364 6.364-1.414-1.414z"
                fill="currentColor"
              />
            </svg>
          </button>

          <div class="separator">
            <span>OR</span>
          </div>

          <button type="button" id="googleSignUp" class="social-button">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              width="18"
              height="18"
            >
              <path
                d="M3.064 7.51A9.996 9.996 0 0 1 12 2c2.695 0 4.959.99 6.69 2.605l-2.867 2.868C14.786 6.482 13.468 5.977 12 5.977c-2.605 0-4.81 1.76-5.595 4.123-.2.6-.314 1.24-.314 1.9 0 .66.114 1.3.314 1.9.786 2.364 2.99 4.123 5.595 4.123 1.345 0 2.49-.355 3.386-.955a4.6 4.6 0 0 0 1.996-3.018H12v-3.868h9.418c.118.654.182 1.336.182 2.045 0 3.046-1.09 5.61-2.982 7.35C16.964 21.105 14.7 22 12 22A9.996 9.996 0 0 1 2 12c0-1.614.386-3.14 1.064-4.49z"
                fill="#4285F4"
              />
            </svg>
            <span>Sign up with Google</span>
          </button>
        </form>

        <p class="login-prompt">
          Already have an account? <a href="login.html">Login</a>
        </p>
      </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDJP2XIR51qGTLINiKvEoscYTMt11CaZ5s",
          authDomain: "paytrust-71e30.firebaseapp.com",
          databaseURL: "https://paytrust-71e30-default-rtdb.firebaseio.com/",
          projectId: "paytrust-71e30",
          storageBucket: "paytrust-71e30.appspot.com",
          messagingSenderId: "492609516838",
          appId: "1:492609516838:android:5a924ad3b7e8e508fa3de7",
        };

        // Initialize Firebase (only when the page is fully loaded)
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Function to display toast message
        function showToast(message, type = "info") {
          const toastContainer = document.getElementById("toast-container");
          const toast = document.createElement("div");
          toast.className = `toast toast-${type}`;

          toast.innerHTML = `
          <div class="toast-content">
            <span>${message}</span>
            <button class="toast-close">Ã—</button>
          </div>
        `;

          toastContainer.appendChild(toast);

          // Add visible class after a small delay (for animation)
          setTimeout(() => {
            toast.classList.add("visible");
          }, 10);

          // Remove toast after 4 seconds
          const timeout = setTimeout(() => {
            removeToast(toast);
          }, 4000);

          // Allow manual closing
          const closeButton = toast.querySelector(".toast-close");
          closeButton.addEventListener("click", () => {
            clearTimeout(timeout);
            removeToast(toast);
          });
        }

        function removeToast(toast) {
          toast.classList.remove("visible");
          setTimeout(() => {
            toast.remove();
          }, 300); // Match this with CSS transition time
        }

        // Password validation
        const passwordInput = document.getElementById("password");
        passwordInput.addEventListener("input", validatePassword);

        function validatePassword() {
          const password = passwordInput.value;
          let isValid = true;

          // Password strength indicators
          if (password.length < 8) {
            isValid = false;
          }

          // Update visual feedback (could be expanded)
          passwordInput.classList.toggle("invalid", !isValid);
        }

        // Toggle password visibility
        const togglePassword = document.getElementById("togglePassword");

        togglePassword.addEventListener("click", () => {
          const type =
            passwordInput.getAttribute("type") === "password"
              ? "text"
              : "password";
          passwordInput.setAttribute("type", type);

          // Update icon based on password visibility
          if (type === "text") {
            togglePassword.innerHTML =
              '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path d="M17.882 19.297A10.949 10.949 0 0 1 12 21c-5.392 0-9.878-3.88-10.819-9a10.982 10.982 0 0 1 3.34-6.066L1.392 2.808l1.415-1.415 19.799 19.8-1.415 1.414-3.31-3.31zM5.935 7.35A8.965 8.965 0 0 0 3.223 12a9.005 9.005 0 0 0 13.201 5.838l-2.028-2.028A4.5 4.5 0 0 1 8.19 9.604L5.935 7.35zm6.979 6.978l-3.242-3.242a2.5 2.5 0 0 0 3.241 3.241zm7.893 2.264l-1.431-1.43A8.935 8.935 0 0 0 20.777 12 9.005 9.005 0 0 0 9.552 5.338L7.974 3.76C9.221 3.27 10.58 3 12 3c5.392 0 9.878 3.88 10.819 9a10.947 10.947 0 0 1-2.012 4.592zm-9.084-9.084l1.442 1.442a2.5 2.5 0 0 0-1.442-1.442z" fill="#607D8B"/></svg>';
          } else {
            togglePassword.innerHTML =
              '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path d="M12 3c5.392 0 9.878 3.88 10.819 9-.94 5.12-5.427 9-10.819 9-5.392 0-9.878-3.88-10.819-9C2.121 6.88 6.608 3 12 3zm0 16a9.005 9.005 0 0 0 8.777-7 9.005 9.005 0 0 0-17.554 0A9.005 9.005 0 0 0 12 19zm0-2.5a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9zm0-2a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z" fill="#607D8B"/></svg>';
          }
        });

        // Phone number formatting
        // Phone number formatting
        const phoneInput = document.getElementById("phone");
        phoneInput.addEventListener("input", (e) => {
          // Basic phone number formatting without hyphens
          let value = e.target.value.replace(/\D/g, "");

          // Limit to standard 10-digit phone number
          if (value.length > 11) {
            value = value.slice(0, 11);
          }

          e.target.value = value;
        });

        // Handle signup form submission
        document
          .getElementById("signupForm")
          .addEventListener("submit", (e) => {
            e.preventDefault();

            if (!document.getElementById("termsAgreement").checked) {
              showToast(
                "You must agree to the Terms of Service and Privacy Policy to continue.",
                "error"
              );
              return;
            }

            const fullName = document.getElementById("fullName").value;
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const phone = document.getElementById("phone").value;

            // Show loading state
            const signupButton = document.querySelector(".signup-button");
            const originalButtonText = signupButton.innerHTML;
            signupButton.disabled = true;
            signupButton.innerHTML =
              '<span>Creating Account...</span><div class="spinner"></div>';

            // Create user with Firebase Authentication
            auth
              .createUserWithEmailAndPassword(email, password)
              .then((userCredential) => {
                const user = userCredential.user;

                // Save user data to Firebase Realtime Database
                const userRef = database.ref("users/" + user.uid);
                return userRef
                  .set({
                    fullName: fullName,
                    email: email,
                    phone: phone,
                    balance: 0.0, // Initial balance
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                  })
                  .then(() => {
                    return user;
                  });
              })
              .then((user) => {
                // Update profile with displayName
                return user
                  .updateProfile({
                    displayName: fullName,
                  })
                  .then(() => {
                    return {
                      uid: user.uid,
                      displayName: fullName,
                      email: user.email,
                    };
                  });
              })
              .then((userData) => {
                // Save minimal user info in localStorage
                localStorage.setItem(
                  "user",
                  JSON.stringify({
                    uid: userData.uid,
                    fullName: userData.displayName,
                    email: userData.email,
                    balance: 0.0,
                  })
                );

                showToast("Account created successfully!", "success");

                // Redirect to login page after 2 seconds
                setTimeout(() => {
                  window.location.href = "login.html";
                }, 2000);
              })
              .catch((error) => {
                console.error("Signup error:", error);

                // Show user-friendly error messages
                let errorMessage;
                switch (error.code) {
                  case "auth/email-already-in-use":
                    errorMessage =
                      "This email is already registered. Please try logging in instead.";
                    break;
                  case "auth/weak-password":
                    errorMessage =
                      "Password is too weak. Please choose a stronger password.";
                    break;
                  case "auth/invalid-email":
                    errorMessage = "Please enter a valid email address.";
                    break;
                  case "auth/network-request-failed":
                    errorMessage =
                      "Network error. Please check your connection.";
                    break;
                  default:
                    errorMessage = error.message;
                }

                showToast(errorMessage, "error");

                // Reset button state
                signupButton.disabled = false;
                signupButton.innerHTML = originalButtonText;
              });
          });

        // Google Sign-Up
        document
          .getElementById("googleSignUp")
          .addEventListener("click", () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: "select_account" });

            auth
              .signInWithPopup(provider)
              .then((result) => {
                const user = result.user;
                const isNewUser = result.additionalUserInfo.isNewUser;

                // If this is a new user, save their data to the database
                if (isNewUser) {
                  const userRef = database.ref("users/" + user.uid);
                  return userRef
                    .set({
                      fullName: user.displayName || "User",
                      email: user.email,
                      phone: "",
                      balance: 0.0,
                      photoURL: user.photoURL,
                      createdAt: firebase.database.ServerValue.TIMESTAMP,
                    })
                    .then(() => {
                      return user;
                    });
                }

                return user;
              })
              .then((user) => {
                // Save minimal user info in localStorage
                localStorage.setItem(
                  "user",
                  JSON.stringify({
                    uid: user.uid,
                    fullName: user.displayName || "User",
                    email: user.email,
                    balance: 0.0,
                    photoURL: user.photoURL,
                  })
                );

                showToast("Account created successfully!", "success");

                // Redirect to home page after 2 seconds
                setTimeout(() => {
                  window.location.href = "home.html";
                }, 2000);
              })
              .catch((error) => {
                console.error("Google Sign-Up error:", error);
                showToast(error.message, "error");
              });
          });
      });
    </script>
  </body>
</html>
